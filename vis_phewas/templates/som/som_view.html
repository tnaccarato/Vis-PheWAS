{% extends 'base.html' %}
{% load static %}
{% block title %}SOM Visualization{% endblock %}
{% block head %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="{% static 'mainapp/js/som.js' %}"></script>
    <style>
        .checkbox-container {
            column-count: 3;
            column-gap: 20px;
        }

        .checkbox-container label {
            display: block;
            margin-bottom: 5px;
        }

        #som-visualisation {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #80e5fa;
        }

    </style>
{% endblock %}
{% block content %}
    <div id="som-visualisation" style="display: flex; flex-direction: column; align-items: center">
        <h1>SOM Visualization</h1>
        <form id="filter-form" style="display: flex; flex-direction: column" onsubmit="handleSubmit(event)">
            {% if type == 'disease' %}
                <div class="disease-filters" style="display: flex; align-content: center; flex-direction: column">
                    <h2 style="align-self: center">Filter by Disease Category</h2>
                    <div class="checkbox-container">
                        {% for category in categories %}
                            <input type="checkbox" id="{{ category }}" name="filters" value="{{ category }}"
                                    {% if category in filters %} checked {% endif %}>
                            <!-- Check the checkbox if it is in the selected filters -->
                            <label for="{{ category }}">{{ category }}</label>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            <!-- Get a slider for number of clusters -->
            <div class="cluster-slider" style="align-self: center">
                <label for="clusters">Number of Clusters:</label>
                <input type="range" id="clusters" name="clusters" min="2" max="10" value={{ num_clusters }}>
                <!-- Add a tooltip showing the current value of the slider -->
                <span id="clusters-value">{{ num_clusters }}</span>
            </div>
            <div style="display: flex;flex-direction: row;justify-content: space-around;margin-top: 10px;">

                <!-- Add a button to submit the form -->
                <button type="submit" class="button btn btn-success" style="align-self: normal;">
                    Generate SOM with Selection
                </button>
                <!-- Add a button to download the cluster results CSV -->
                <button class="button btn btn-info" type="button">
                    <a style="text-decoration: none;color: whitesmoke;text-shadow: 1px 0 3px black;" href="{{ csv_path }}" download="cluster_results.csv">Download Cluster Results CSV</a>
                </button>
            </div>
        </form>


        <div id="plotly-div">
            {{ graph_div|safe }}
        </div>

    </div>


    <script>
        function getSelectedFilters() {
            const selectedFilters = [];
            const baseFilter = 'category_string:==:';

            document.querySelectorAll('input[name="filters"]:checked').forEach((checkbox) => {
                selectedFilters.push(baseFilter + checkbox.value);
            });

            // Join filters with " OR " to match the format
            const joinedFilters = selectedFilters.join(' OR ');
            // Encode the joined filters to be used in the URL
            return encodeURIComponent(joinedFilters);
        }

        // Function to load selected filters from localStorage on page load
        function loadSelectedFilters() {
            const selectedFilters = JSON.parse(localStorage.getItem('selectedFilters'));
            if (selectedFilters) {
                selectedFilters.forEach((filter) => {
                    const category = filter.replace('category_string:==:', '');
                    const checkbox = document.getElementById(category);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        // Call the function to load selected filters on page load
        document.addEventListener('DOMContentLoaded', loadSelectedFilters);

        // Function to handle form submission
        function handleSubmit(event) {
            event.preventDefault(); // Prevent form submission and page reload
            const filters = getSelectedFilters();
            const num_clusters = document.getElementById('clusters').value;
            console.log("Number of clusters: ", num_clusters);
            // Call the generateSOM function with the filters, type and number of clusters
            generateSOM(filters, 'disease', num_clusters);
        }

        // Function to update the displayed value of the slider
        document.getElementById('clusters').addEventListener('input', function () {
            document.getElementById('clusters-value').textContent = this.value;
            console.log(this.value);
        });

    </script>
    </body>
{% endblock %}